### new

newçš„å››ä¸ªé˜¶æ®µï¼š

1. åˆ›å»ºä¸€ä¸ªç©ºçš„ç®€å•JavaScriptå¯¹è±¡ï¼ˆå³**{}**ï¼‰ï¼›
2. è¿™ä¸ªæ–°å¯¹è±¡å†…éƒ¨çš„[[Prototype]] ç‰¹æ€§è¢«èµ‹å€¼ä¸ºæ„é€ å‡½æ•°çš„prototype å±æ€§ ï¼›
3. è®©Funcä¸­çš„thisæŒ‡å‘objï¼Œå¹¶æ‰§è¡ŒFuncçš„å‡½æ•°ä½“ã€‚
4. åˆ¤æ–­Funcçš„è¿”å›å€¼ç±»å‹ï¼šå¦‚æœæ˜¯å€¼ç±»å‹ï¼Œè¿”å›objã€‚å¦‚æœæ˜¯å¼•ç”¨ç±»å‹ï¼Œå°±è¿”å›è¿™ä¸ªå¼•ç”¨ç±»å‹çš„å¯¹è±¡ã€‚



##### version 1

è¿™ä¸ªç‰ˆæœ¬æŒ‰æ­¥éª¤ç®€å•åœ°å®ç°äº†new

```js
function Person(){
    this.name='he';
    return 1;
}

const myNew=()=>{
    let obj={};   //1
    obj.__proto__=Person.prototype; //2
    let res=Person.call(obj);   //3
    return typeof res==="object"? res:obj; //4
}
```

ğŸ’£ç¼ºç‚¹: 

1. æ²¡æœ‰è€ƒè™‘newä¸­ä¼ å‚æ•°çš„æƒ…å†µ
2. å¯¹å¼•ç”¨ç±»å‹çš„åˆ¤æ–­åªæœ‰object, ä½†funtionä¹Ÿæ˜¯å¼•ç”¨ç±»å‹ä½œä¸ºobject, ä½†æ˜¯typeofåˆ¤æ–­functionæ—¶ä¸ä¸ºobject, è€Œæ˜¯function
3. myNewä¸å…·æœ‰é€šç”¨æ€§, å¦‚æœæ¢ä¸€ä¸ªæ„é€ å‡½æ•°é‚£ä¹ˆéœ€è¦å†å†™ä¸€ä¸ªmyNew



##### version 2

```js
function Person() {
    this.name = 'ciel';
    this.arg = [...arguments];
}
Person.prototype.callName = function() {
    console.log(this.name)
}

function myNew(fn) {  //fnä¸ºè¦newçš„å‡½æ•°
    let obj=Object.create(fn.prototype);  //1,2æ­¥
    let args=[...arguments].slice(1);     //è·å–å‚æ•°
    let result=fn.call(obj,...args);      //3
    return typeof result==='object'||result instanceof Function? result:obj;   //4
}
```

è¿™ä¸€ç‰ˆå°±å®Œç¾è§£å†³äº†ä¸Šä¸€ç‰ˆçš„è¯¸å¤šé—®é¢˜

ğŸŒŸé‡‡ç”¨äº† Object.create è¿™ä¸ªapiä½¿å¾—ä¸¤æ­¥å˜ä¸ºä¸€æ­¥ (Object.createåˆ›å»ºä¸€ä¸ªæ–°çš„ç©ºå¯¹è±¡,å¹¶ä¸”è¯¥ç©ºå¯¹è±¡çš„\__proto__å±æ€§å°±æ˜¯ç¬¬ä¸€ä¸ªå‚æ•°)

ğŸŒŸå¸¸ç”¨çš„å‚æ•°åˆ†å‰²æ–¹æ³•æ˜¯Array.prototype.slice.call(arguments, 1), è¿™é‡Œä½¿ç”¨æ‰©å±•è¿ç®—ç¬¦æ›´å°†ç®€æ´ (argumensæ˜¯ç±»æ•°ç»„å¯¹è±¡, ä½†è‡ªå¸¦iteratoræ¥å£, æ‰€ä»¥å¯ä»¥è¢«æ‰©å±•è¿ç®—ç¬¦è½¬æ¢)

ğŸŒŸåœ¨ç¬¬å››æ­¥æ·»åŠ äº†å¯¹funtionçš„åˆ¤æ–­, æ„Ÿè§‰typeof result==='function' ä¹Ÿå¯ä»¥çš„ã€‚ æ›´ç®€æ´çš„æ–¹å¼å¯ä»¥é‡‡ç”¨  myNew instanceof  Object ï¼ˆä¸çŸ¥é“è¿™ç§å¯¹ä¸å¯¹...ï¼‰

æµ‹è¯•ä»£ç :

```js
// æµ‹è¯• å°±åƒé€šå¸¸çš„ new foo()
let test = myNew(Person, 'hhh', '123', 'saf')
test.callName()
console.log(test)
```



##### version 3

ä¸Šä¸€ç‰ˆå·²ç»å¾ˆå®Œç¾äº†, ä¸ºå•¥è¿˜è¦æŠ›å‡ºè¿™ä¸€ç‰ˆå‘¢?

â–¼å› ä¸ºæˆ‘åœ¨segmentfaultæäº†ä¸€ä¸ªé—®é¢˜ [jsåˆ¤æ–­å¼•ç”¨ç±»å‹ - SegmentFault æ€å¦](https://segmentfault.com/q/1010000039924686?_ea=127865972) , åŸæœ¬æ˜¯æƒ³é—®ä¸€ä¸‹èƒ½ä¸èƒ½ç”¨ result  instanceof Object åˆ¤æ–­å¼•ç”¨ç±»å‹, ä½†æ˜¯å‘ç°äº†ä¸Šä¸€ç‰ˆçš„é—®é¢˜!!!

newæ“ä½œç¬¦åªæ˜¯å¯¹äºresultä¸ºå¼•ç”¨ç±»å‹ä¼šç›´æ¥è¿”å›è¯¥result, ä½†æ˜¯æˆ‘å†™çš„ä¼šæŠŠnullé”™è¯¯çš„åˆ¤æ–­ä¸ºå¼•ç”¨ç±»å‹, ä½†å®é™…ä¸Šnullä¸ºåŸºæœ¬ç±»å‹

```js
return typeof result==='object'||result instanceof Function?  result:obj;  //4
```

åœ¨å®é™…çš„æµ‹è¯•ä¸­å¯ä»¥å‘ç°å½“è¿”å›nullæ—¶åŸç”Ÿçš„newä¾æ—§è¿”å›objè€Œä¸æ˜¯null ( <span style=" color:red;">å› ä¸º typeof null çš„ç»“æœæ˜¯object</span> )

```js
function Person() {
    this.name = 'ciel';
    this.arg = [...arguments];
    return null;
}
let p=new Person('123','1');
console.log(p);      // Person { name: 'ciel', arg: [ '123', '1' ] }
```



â–¼æ‰€ä»¥åº”è¯¥æ€ä¹ˆæ”¹å‘¢?  åœ¨å¤§ä½¬ç»™çš„è§£ç­”ä¸­å‘ç°æˆ‘è‡ªå·±çš„æƒ³æ³•æ˜¯å¯¹çš„

>åœ¨javascriptä¸­æ‰€æœ‰å¼•ç”¨ç±»å‹çš„åŸå‹é“¾ä¸­éƒ½åŒ…å«Object.prototypeï¼Œæ‰€ä»¥ `result instanceof Object`èƒ½å¯¹æ‰€æœ‰çš„å¼•ç”¨ç±»å‹è¿”å›true

è€Œä¸”è¿™ç§å†™æ³•å³ä½¿åŸå‡½æ•°è¿”å›nullä¹Ÿä¼šè¿”å›obj, å› ä¸ºnull instanceof Object ä¸ºfalse (nullæœ¬èº«å°±æ˜¯ä¸ªç©ºå¯¹è±¡æŒ‡é’ˆå•¥ä¹Ÿæ²¡æœ‰æ›´åˆ«è¯´åŸå‹é“¾äº†). 

**å› æ­¤æœ€ä½³å†™æ³•å¦‚ä¸‹:**

```js
function myNew(fn) {
    let obj=Object.create(fn.prototype);  //1,2æ­¥
    let args=[...arguments].slice(1);     //è·å–å‚æ•°
    let result=fn.call(obj,...args);      //3
    return result instanceof Object ? result:obj;   //4
}
```

* å¯ä»¥ç”¨å‰é¢çš„æµ‹è¯•ä»£ç è¿›è¡Œæµ‹è¯•



### call

é¦–å…ˆäº†è§£ä¸€ä¸‹call:`call()` æ–¹æ³•ä½¿ç”¨ä¸€ä¸ªæŒ‡å®šçš„ `this` å€¼å’Œå•ç‹¬ç»™å‡ºçš„ä¸€ä¸ªæˆ–å¤šä¸ªå‚æ•°æ¥è°ƒç”¨ä¸€ä¸ªå‡½æ•°ã€‚

> function.call(thisArg, arg1, arg2, ...)

å¦‚æœä¸æä¾›thisArgæˆ–è€…thisArgä¸ºnullæˆ–undefinedé‚£ä¹ˆthisä¼šæ›¿æ¢ä¸ºå…¨å±€å¯¹è±¡

â–¼è¿”å›å€¼

ä½¿ç”¨è°ƒç”¨è€…æä¾›çš„ `this` å€¼å’Œå‚æ•°è°ƒç”¨è¯¥å‡½æ•°çš„è¿”å›å€¼ã€‚è‹¥è¯¥æ–¹æ³•æ²¡æœ‰è¿”å›å€¼ï¼Œåˆ™è¿”å› `undefined`ã€‚



```js
Function.prototype.myCall=function (target, ...args) {
    //thisä¸ºè°ƒç”¨myCallçš„å‡½æ•°å¯¹è±¡
    if (typeof this !=='function'){
        throw new TypeError('not a function')
    }
    //æ²¡æœ‰æä¾›targetçš„æƒ…å†µä¸‹thisä¸ºé¡¶å±‚å¯¹è±¡ã€‚ç®€åŒ–ä¸€ä¸‹ï¼Œé»˜è®¤æ˜¯chromeç¯å¢ƒ,
    target=target || window;
    target.fn=this;  //éšå¼ç»‘å®š,æ”¹å˜æ„é€ å‡½æ•°çš„è°ƒç”¨è€…é—´æ¥æ”¹å˜ this æŒ‡å‘
    return target.fn(...args);
}
```

ğŸŒŸæ„Ÿè§‰è¿™ä¸ªéšå¼ç»‘å®šå¾ˆnice!!!  å°†è¦æ‰§è¡Œçš„å‡½æ•°å½“ä½œtargetçš„ä¸€ä¸ªå±æ€§, ç›´æ¥æ”¹å˜è°ƒç”¨è€…æ¥é—´æ¥æ”¹å˜thisæŒ‡å‘



æµ‹è¯•ä»£ç :

```js
let obj = { name: 123 }
function foo(...args) {
    console.log(this);
    console.log(this.name, args);
}

let re=foo.myCall(obj,1,2);
console.log(re);
```



plus:

applyç±»ä¼¼äºcall, åªä¸è¿‡applyç¬¬äºŒä¸ªå‚æ•°ä¸ºæ•°ç»„æˆ–ç±»æ•°ç»„å¯¹è±¡, ä½†æˆ‘æš‚æ—¶ä¸çŸ¥é“å¦‚ä½•åˆ¤æ–­ç±»æ•°ç»„å¯¹è±¡...



### reduce

é¦–å…ˆç†è§£reduceåšäº†ä»€ä¹ˆ?   [æºç link]([ECMAScriptÂ® 2022 Language Specification (tc39.es)](https://tc39.es/ecma262/#sec-array.prototype.reduce))

â–¼reduce()çš„å‚æ•°:

**callback**   (å°±æ˜¯ä¸Šé¢çš„é‚£ä¸ªreducer)

æ‰§è¡Œæ•°ç»„ä¸­æ¯ä¸ªå€¼ (å¦‚æœæ²¡æœ‰æä¾› initialValueåˆ™ç¬¬ä¸€ä¸ªå€¼é™¤å¤–)çš„å‡½æ•°ï¼ŒåŒ…å«å››ä¸ªå‚æ•°ï¼š

â€‹		**accumulator**

â€‹		ç´¯è®¡å™¨ç´¯è®¡å›è°ƒçš„è¿”å›å€¼; å®ƒæ˜¯ä¸Šä¸€æ¬¡è°ƒç”¨å›è°ƒæ—¶è¿”å›çš„ç´¯ç§¯å€¼ï¼Œæˆ–initialValueï¼ˆè§äºä¸‹æ–¹ï¼‰ã€‚

â€‹		**currentValue**

â€‹		æ•°ç»„ä¸­æ­£åœ¨å¤„ç†çš„å…ƒç´ ã€‚

â€‹		**index** **å¯é€‰**

â€‹		æ•°ç»„ä¸­æ­£åœ¨å¤„ç†çš„å½“å‰å…ƒç´ çš„ç´¢å¼•ã€‚ å¦‚æœæä¾›äº†initialValueï¼Œåˆ™èµ·å§‹ç´¢å¼•å·ä¸º0ï¼Œå¦åˆ™ä»ç´¢å¼•1èµ·å§‹ã€‚

â€‹		**array ** **å¯é€‰**

â€‹		è°ƒç”¨reduce()çš„æ•°ç»„

**initialValue** **å¯é€‰**

ä½œä¸ºç¬¬ä¸€æ¬¡è°ƒç”¨ callbackå‡½æ•°æ—¶çš„ç¬¬ä¸€ä¸ªå‚æ•°çš„å€¼ã€‚ å¦‚æœæ²¡æœ‰æä¾›åˆå§‹å€¼ï¼Œåˆ™å°†ä½¿ç”¨æ•°ç»„ä¸­çš„ç¬¬ä¸€ä¸ªå…ƒç´ ã€‚ åœ¨æ²¡æœ‰åˆå§‹å€¼çš„ç©ºæ•°ç»„ä¸Šè°ƒç”¨ reduce å°†æŠ¥é”™



ğŸŒŸå›è°ƒå‡½æ•°ç¬¬ä¸€æ¬¡æ‰§è¡Œæ—¶ï¼Œaccumulator å’ŒcurrentValueçš„å–å€¼æœ‰ä¸¤ç§æƒ…å†µï¼š
 1.å¦‚æœè°ƒç”¨reduce()æ—¶æä¾›äº†initialValueï¼Œaccumulatorå–å€¼ä¸ºinitialValueï¼ŒcurrentValueå–æ•°ç»„ä¸­çš„ç¬¬ä¸€ä¸ªå€¼ï¼›
 2.å¦‚æœæ²¡æœ‰æä¾› initialValueï¼Œé‚£ä¹ˆaccumulatorå–æ•°ç»„ä¸­çš„ç¬¬ä¸€ä¸ªå€¼ï¼ŒcurrentValueå–æ•°ç»„ä¸­çš„ç¬¬äºŒä¸ªå€¼ã€‚

â—**æ³¨æ„ï¼š**å¦‚æœæ²¡æœ‰æä¾›initialValueï¼Œreduce ä¼šä»ç´¢å¼•1çš„åœ°æ–¹å¼€å§‹æ‰§è¡Œ callback æ–¹æ³•ï¼Œè·³è¿‡ç¬¬ä¸€ä¸ªç´¢å¼•ã€‚å¦‚æœæä¾›initialValueï¼Œä»ç´¢å¼•0å¼€å§‹ã€‚

 

â—â—â—å¦‚æœæ•°ç»„ä¸ºç©ºä¸”æ²¡æœ‰æä¾›initialValueï¼Œä¼šæŠ›å‡º[TypeError](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/TypeError) ã€‚å¦‚æœæ•°ç»„ä»…æœ‰ä¸€ä¸ªå…ƒç´ ï¼ˆæ— è®ºä½ç½®å¦‚ä½•ï¼‰å¹¶ä¸”æ²¡æœ‰æä¾›initialValueï¼Œ æˆ–è€…æœ‰æä¾›initialValueä½†æ˜¯æ•°ç»„ä¸ºç©ºï¼Œé‚£ä¹ˆæ­¤å”¯ä¸€å€¼å°†è¢«è¿”å›å¹¶ä¸”callbackä¸ä¼šè¢«æ‰§è¡Œã€‚



```js
Object.defineProperty(Array.prototype,'myReduce',{
    value:function (callback) {
        //ç‰¹æ®Šå¤„ç†
        if (this===null){
            throw new TypeError('reduce called on null or undefined!');
        }
        if (typeof callback!=='function'){
            throw new TypeError(callback + 'is not a function!');
        }

        //oæ˜¯è¿›è¡Œreduceçš„å¯¹è±¡
        let o=Object(this);
        //>>>0: å°†ä»»æ„jså€¼è½¬æ¢ä¸ºæ•°å­—,ä¸”ä¸ä¼šå‡ºç°NaN
        let len=o.length>>>0;

        let k=0;
        let value;

        if (arguments.length>=2){ //æœ‰initialValue
            value=arguments[1];
        }else {
            //kè¡¨ç¤ºçš„æ˜¯index; çŒœæµ‹æ˜¯ä¸ºäº†æ’é™¤[ <3 empty items>, 1, 2 ]çš„æƒ…å†µ
            //è¿™é‡Œçš„kå¯ä»¥ç†è§£ä¸ºå¼€å§‹reduceçš„ä½ç½®
            while (k<len&&!(k in o)){
                k++;
            }
            //å¦‚æœkå¤§äºç­‰äºlen,åˆ™è¯´æ˜èµ·å§‹ä½ç½®å·²ç»è¶…å‡ºäº†æ•°ç»„èŒƒå›´
            //ä¹Ÿå°±æ˜¯è¡¨æ˜è¿™æ˜¯ä¸€ä¸ªç©ºæ•°ç»„,è€Œè¿™ä¸ªelseåˆ†æ”¯ä¸ºæ²¡æœ‰initialValueçš„æƒ…å†µ,å› æ­¤æŠ›å‡ºé”™è¯¯
            if (k>=len){
                throw new TypeError('Reduce of empty array with no initial value');
            }
            //è¿™é‡Œçš„valueå…¶å®å°±æ˜¯åœ¨æŒ‡å®šaccumulator
            value=o[k++];
        }
        
        while (k<len){
            //é¿å…è¿™ç§æƒ…å†µ:[ <3 empty items>, 1, <1 empty item>, 2 ]
            if (k in o){
                value=callback(value,o[k],k,o);
            }
            k++;
        }
        return value;
    }
});
```

è¿™é‡Œè¿›è¡Œé€è¡Œè§£æ:

1. <span style="color:blue ;">if(this==null)</span> æ²¡æƒ³é€šå†™è¿™ä¸ªçš„æ„ä¹‰..., å› ä¸ºåªæœ‰Arrayæ‰æœ‰æˆ‘å†™çš„è¿™ä¸ªmyReduceæ–¹æ³•, è€Œnullä¸Šæ— æ³•å®šä¹‰prototypeå±æ€§æˆ–è€…æ–¹æ³•, ä½¿ç”¨null.reduceæŠ¥é”™æ˜¯Cannot read property 'reduce' of nullã€‚æ„Ÿè§‰å¯ä»¥å»æ‰è¿™ä¸ªåˆ¤æ–­ (æºç ä¸­ä¹Ÿæ²¡è¿›è¡Œè¿™ä¸ªåˆ¤æ–­!)
   ğŸŒŸæ›´æ–°: å› ä¸ºjsä¸­æœ‰call, å› æ­¤æˆ‘ä»¬å¦‚æœä½¿ç”¨Array.prototype.reduce.call() å°±å¯ä»¥å°†è¿™ä¸ªæ–¹æ³•ä½œç”¨åŸŸä»»ä½•å¯¹è±¡ä¸Š, å› æ­¤æˆ‘ä»¬è¦è€ƒè™‘åˆ°è¿™ç§æƒ…å†µ!!!

2. <span style="color:blue ;">if (typeof callback!=='function')</span> **è¿™ä¸ªè¿˜æ˜¯æœ‰å¿…è¦çš„,** reduceå¿…é¡»ä¼ å…¥ä¸€ä¸ªcallback function

3. <span style="color:blue;">let o=Object(this);</span>  æ„Ÿè§‰è¿™é‡Œä½œç”¨ä¸å¤§, ç”±äºthisæ˜¯å¯¹è±¡, å› æ­¤è°ƒç”¨Object(this) è¿”å›çš„ä»æ˜¯ä¸thisæŒ‡å‘çš„å¯¹è±¡çš„å¼•ç”¨åœ°å€ ä¹Ÿå°±æ˜¯è¯´ o===this :**true**ã€‚ å¯èƒ½æ˜¯æ¢ä¸€ä¸ªå˜é‡æ¥æŒ‡å‘thisï¼Ÿ 
   ğŸŒŸåŒ1ä¸­çš„æ›´æ–°

4. <span style="color:blue ;">let len=o.length>>>0;</span> æ›´å…·é²æ£’æ€§ï¼Œä»»ä½•å€¼éƒ½èƒ½è½¬æ¢ä¸ºæ•°å­— NaN>>>0 =0.... ,è¿™æˆ‘ä¹Ÿä¸çŸ¥é“æ„ä¹‰åœ¨å“ª, thisåº”è¯¥ä¸ºæ•°ç»„å§...
   ğŸŒŸåŒ1ä¸­çš„æ›´æ–°

5. <span style="color:blue ;">if (arguments.length>=2)</span>  è¿™é‡Œè¡¨ç¤ºå‚æ•°é•¿åº¦å¤§äºç­‰äº2ï¼Œè¯´æ˜ç»™å‡ºäº†initialValueï¼Œå› æ­¤ä»¤value(åœ¨è¿™é‡Œç›¸å½“äºaccumulator)ç­‰äºç»™å‡ºçš„ç¬¬äºŒä¸ªå‚æ•°arguments[1] ã€‚ğŸ’£reduceå†™çš„æ˜¯åªæœ‰ä¸¤ä¸ªå‚æ•°, ä½†ä½ å¤šä¼ å‚æ•°ä¸ä¼šæŠ¥é”™, ä½†å¤šä¼ çš„å‚æ•°æ²¡æœ‰å®è´¨ä½œç”¨! 

6. elseè¡¨ç¤ºå‚æ•°å°äºæˆ–ç­‰äºä¸€ä¸ª:

   a. <span style="color:blue ;">while (k<len&&!(k in o))</span> è¿™é‡Œæ˜¯ä¸ºä»€ä¹ˆå‘¢? é¦–å…ˆå…ˆæ˜ç¡®**inæ“ä½œç¬¦ä¸­kè¡¨ç¤ºçš„æ˜¯index**!! è¿™é‡Œçš„kå®é™…ä¸Šæ˜¯æƒ³æ‰¾åˆ°æ•°ç»„ä¸­å¼€å§‹æœ‰å€¼çš„èµ·å§‹ä½ç½®ã€‚ å› ä¸ºå­˜åœ¨ç€è¿™ç§æƒ…å†µï¼š let a=[];  a[3]=1; é‚£ä¹ˆè¿™ä¸ªæ•°ç»„å°±ä¸º 

   **[ <3 empty items>, 1]** ã€‚ç„¶è€Œåœ¨è¿™ç§æƒ…å†µä¸‹ å¯¹åº”çš„empty itemçš„ç´¢å¼•é‡‡ç”¨ in æ“ä½œç¬¦åˆ¤æ–­æ˜¯ä¸ºfalseçš„ã€‚æ¯”å¦‚è¿™ä¸ªä¾‹å­ä¸­ 0 in oï¼Œ1 in oï¼Œ2 in oéƒ½ä¸ºfalseï¼Œå› æ­¤è·³è¿‡è¿™äº›ä¸ºfalseçš„itemsæˆ‘ä»¬å°±èƒ½æ‰¾åˆ°èµ·å§‹ä½ç½®3ï¼š1


   b.<span style="color:blue ;">if (k>=len)</span> å½“ç„¶æ•°ç»„å¯èƒ½ä¸ºå…¨ç©ºã€‚æ¯”å¦‚è¯´Array(4):  **[ <4 empty items>]** , kè¡¨ç¤ºèµ·å§‹ä½ç½®, å½“ç„¶ä¹Ÿæ˜¯åœ¨æ•°ç»„ä¸­çš„ç´¢å¼•, å¦‚æœè¿™ä¸ªå€¼åœ¨ä¸Šä¸€è½®whileå¾ªç¯åå¤§äºç­‰äºlen, é‚£ä¹ˆè¯´æ˜è¿™ä¸ªæ•°ç»„ä¸ºç©º!  å¹¶ä¸”è¿™ä¸ªelseåˆ†æ”¯ä¸ºæ²¡æœ‰initialValueçš„æƒ…å†µ,å› æ­¤æŠ›å‡ºé”™è¯¯âŒ

   c.<span style="color:blue ;">value=o[k++];</span> èƒ½èµ°åˆ°è¿™ä¸€æ­¥è¯´æ˜æ•°ç»„åœ¨æ²¡æœ‰initialValueçš„æƒ…å†µä¸‹æ˜¯å­˜åœ¨å€¼çš„, kä¹Ÿæ˜¯æ•°ç»„ä¸­çš„ç¬¬ä¸€ä¸ªå€¼çš„ç´¢å¼•, å› æ­¤æˆ‘ä»¬å°†è¯¥å€¼èµ‹ç»™value(ç›¸å½“äºaccumulator); ç„¶åk++è¿›è¡Œä¸‹é¢çš„whileå¾ªç¯

7. <span style="color:blue ;">while (k<len)</span> è¿™é‡Œå°±æ˜¯å¼€å§‹æ­£å¼è¿›è¡Œreduceä¸­callbackçš„è°ƒç”¨äº†!  ğŸŒŸå½“ç„¶è¿™é‡Œä¹Ÿå¾ˆé‡è¦!!! æ»¡è¶³äº†1.ç©ºæ•°ç»„ä½†æœ‰initialValue 2.æ•°ç»„ä¸­åªæœ‰ä¸€ä¸ªå€¼ä½†æ²¡æœ‰initialValue è¿™ä¸¤ç§æƒ…å†µç›´æ¥è¿”å›value !!! 

8. <span style="color:blue ;">if (k in o)</span> :å¯¹ä¸­é—´æœ‰empty itemçš„è€ƒè™‘ **[ <3 empty items>, 1, <1 empty item>, 2 ]** 

9. <span style="color:blue ;">value=callback(value,o[k],k,o);</span>   æŒ‰ç…§å‚æ•°æ ¼å¼é¡ºåºå¡«ä¸Šå°±å¥½, å…·ä½“å¦‚ä½•æ‰§è¡Œä¸ç”¨å»ç®¡

   1. value: accumulator
   2. o[k] : currentValue
   3. k: index
   4. o: array	 

ğŸ’£å…¶å®è¿™é‡Œçš„ç¬¬ä¸€æ­¥åˆ¤æ–­å’ŒåŸç”Ÿæ–¹æ³•æ¯”èµ·æ¥è¿˜æ˜¯æœ‰ç‚¹ä¸åŒ, æˆ‘ä»¬è°ƒç”¨ Array.prototype.reduce.call(null)æ—¶å®é™…ä¸Šä¼šæŠŠé¡¶å±‚å¯¹è±¡å½“ä½œthisæ¥ä¼ å…¥ï¼Œä¸è¿‡åŸç”Ÿçš„reduceä¹Ÿèƒ½åˆ¤æ–­å‡ºæ˜¯nullè¿˜æ˜¯undefinedã€‚ä½†æ˜¯æˆ‘ä»¬è‡ªå·±å†™çš„æ–¹æ³•æ˜¯ä¼šç›´æ¥æŠŠglobalå½“ä½œthisä¼ è¿›å»çš„å› ä¸º globalä¸ç­‰äºnull ! 

å½“ç„¶æˆ‘è§‰å¾—è¿™ä¸ªreduceæ–¹æ³•æ²¡å¿…è¦è¿™ä¹ˆæ·±ç©¶ï¼Œè¿™é‡Œå¯èƒ½ä¼šæƒ³åˆ°åŠ ä¸Šå¯¹é¡¶å±‚å¯¹è±¡çš„åˆ¤æ–­ï¼Œå¯æˆ‘å‘ç°åŸç”Ÿçš„reduceåŠ ä¸Šé¡¶å±‚å¯¹è±¡ä½œä¸ºå‚æ•°åä¹Ÿèƒ½é€šè¿‡ç¬¬ä¸€å±‚çš„åˆ¤æ–­ã€‚ã€‚Array.prototype.reduce.call(global);  åé¢å°±ä¸æ·±ç©¶äº†ã€‚é‡è¦çš„æ˜¯äº†è§£æœºåˆ¶ï¼Œè€Œä¸æ˜¯å¯¹ç‰¹æ®Šæƒ…å†µçš„è€ƒè™‘ã€‚



æ”¹è¿›åçš„ç®€æ´æ˜“æ‡‚ç‰ˆ(ä¸çŸ¥é“æœ‰æ²¡æœ‰é”™...)

```js
Object.defineProperty(Array.prototype,'simpleReduce',{
    value:function (callback,initialValue) {
        if (this==null){  //undefined==null: t
            throw new TypeError('reduce called on null or undefined!');
        }
        if (typeof callback!=='function'){
            throw new TypeError(callback+'not a function!');
        }

        let arr=Object(this);
        let len=arr.length>>>0;
        let index=0;
        let accumulator;

        if (arguments.length>=2){
            accumulator=initialValue;
        }else {
            while (index<len&&!(index in arr)){
                index++;
            }
            if (index>=len){
                throw new TypeError('Reduce of empty array with no initial value!');
            }
            accumulator=arr[index++];
        }

        while (index<len){
            if (index in arr){
                accumulator=callback(accumulator,arr[index],index,arr);
            }
            index++;
        }
        return accumulator;
    }
})
```



â—ä¸è¦ç”¨ if(initialValue), initialValueå¦‚æœä¸ºfalsyé‚£ä¹ˆä¹Ÿä¼šè¢«å½“ä½œæ²¡ç»™å‡ºinitialValue



### includes

â–¼è¯­æ³•:

arr.includes(valueToFind[, fromIndex])

â–¼å‚æ•°:

**valueToFind** :éœ€è¦æŸ¥æ‰¾çš„å…ƒç´ å€¼ã€‚ (â—åŒºåˆ†å¤§å°å†™)

**fromIndex** **å¯é€‰** :ä»fromIndex ç´¢å¼•å¤„å¼€å§‹æŸ¥æ‰¾ valueToFindã€‚å¦‚æœä¸ºè´Ÿå€¼ï¼Œåˆ™æŒ‰å‡åºä» array.length + fromIndex çš„ç´¢å¼•å¼€å§‹æœ ï¼ˆå³ä»æœ«å°¾å¼€å§‹å¾€å‰è·³ fromIndex çš„ç»å¯¹å€¼ä¸ªç´¢å¼•ï¼Œç„¶åå¾€åæœå¯»ï¼‰ã€‚å¦‚æœfromIndexåœ¨å¤„ç†åè¿˜æœªè´Ÿå€¼é‚£ä¹ˆå°±å½“ä½œfromIndexä¸º0ã€‚ é»˜è®¤ä¸º 0ã€‚

â–¼è¿”å›å€¼:

è¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ [Boolean](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Boolean) ï¼Œå¦‚æœåœ¨æ•°ç»„ä¸­æ‰¾åˆ°äº†ï¼ˆå¦‚æœä¼ å…¥äº† fromIndex ï¼Œè¡¨ç¤ºåœ¨ fromIndex æŒ‡å®šçš„ç´¢å¼•èŒƒå›´ä¸­æ‰¾åˆ°äº†ï¼‰åˆ™è¿”å› true ã€‚



ğŸš©è¿™é‡Œä¸ºäº†æ£€æµ‹æ–¹ä¾¿, å°±ä¸é‡‡ç”¨mdnä¸Šå†™çš„ Object.definePropertyçš„å½¢å¼äº†(å…·ä½“å‘è¯·çœ‹reduceâ—) 

```js
function myIncludes(obj,valueToFind,fromIndex) {
 if (obj==null) throw new TypeError('"this" is null or undefined! ');
 let o=Object(obj);  //å­—ç¬¦ä¸²ä¹Ÿæ”¯æŒ!
 let len=o.length>>>0;
 if (len===0){
  return false;
 }
 let n= fromIndex | 0;   //ä¸è¦ç”¨ ||
 let k=Math.max(n>=0? n:len+n, 0);  //ä»£è¡¨å¼€å§‹è®¡ç®—çš„ä½ç½®
 const sameValueZero=(x,y)=>{  //includeså†…éƒ¨é‡‡ç”¨çš„æ¯”è¾ƒæœºåˆ¶
  return x===y || (typeof x==='number'&&typeof y==="number"&&isNaN(x)&&isNaN(y));
 }
 while (k<len){
  if (sameValueZero(o[k],valueToFind)) return true;
  k++;
 }
 return false;
}
```

1. <span style="color:blue ;">obj==null</span>  å…¶å®å°±åˆ¤æ–­äº†nullå’Œundefinedä¸¤ç§ç±»å‹äº†
2.  <span style="color:blue;">let o=Object(obj);</span>  å…¶å®è¿™é‡Œå¾ˆé‡è¦å“¦! å°†ä¼ è¿›æ¥çš„å‚æ•°éƒ½è½¬æ¢ä¸ºå¯¹è±¡, å­—ç¬¦ä¸²ä¹Ÿä¼šå°†å…¶å˜ä¸ºåŒ…è£…å¯¹è±¡String()
3. <span style="color:blue ;">let n= fromIndex | 0;</span>  å› ä¸ºä¸ç¡®å®šä¼ å…¥çš„fromIndexæ˜¯ä»€ä¹ˆç±»å‹, å› æ­¤è¿™é‡Œé‡‡ç”¨ä½è¿ç®—æ›´å¥½, ä¼šæœ‰ä¸€ä¸ª toInt32 è½¬æ¢çš„è¿‡ç¨‹ã€‚è¿™é‡Œå°±ç»Ÿä¸€æŠŠä¸ç¬¦åˆæ¡ä»¶çš„fromIndexå½“ä½œäº†0æ¥çœ‹å¾… (æ¯”å¦‚å…¶ä»–éNumberç±»å‹), è€Œä¸”ä½è¿ç®—å¯¹NaNä¹Ÿèƒ½è½¬æ¢ä¸º0!!! (typeof NaN = "number")
4. <span style="color:blue ;">Math.max(n>=0? n:len+n, 0)</span>  fromIndexæœ€ç»ˆç»“æœéœ€è¦å¤§äºç­‰äº0ï¼Œ è¯¦æƒ…è§å‚æ•°ä»‹ç»
5. <span style="color:blue ;">sameValueZero</span>  è¿™æ˜¯jsä¸­ä¸€ç§åˆ¤æ–­ç›¸ç­‰çš„æ–¹æ³•ï¼Œ åŒºåˆ«äºsameValueã€‚ï¼ˆsameValueè®¤ä¸º +0 != -0, ä½†sameValueZeroè®¤ä¸ºè¿™ç›¸ç­‰ï¼‰ä¸è¿‡ä¸¤ç§åˆ¤æ–­æ–¹æ³•éƒ½ä¼šè®¤ä¸º NaN=NaN, åŒºåˆ«äº == å’Œ ===
6. æœ€åå°±æ˜¯ä»èµ·å§‹ä½ç½®å¼€å§‹åˆ¤æ–­æœ‰æ— ç›®æ ‡å€¼ã€‚ <span style="font-weight:bold; color:red;">æ”¯æŒStringç±»å‹</span>



ğŸŒŸincludeså¯¹äºåŒ…å«lengthçš„å¯¹è±¡ä¹Ÿå¯ä»¥åˆ¤æ–­å“¦ï¼ï¼ï¼

```js
console.log(Array.prototype.includes.call({a: 1, b: 2,length:3}, 1));  //false
console.log(Array.prototype.includes.call({1: 1, 2: 2,length:3}, 1));  //true
console.log(Array.prototype.includes.call([1,2], 1));                  //true
```





### æ·±æ‹·è´

å‚è€ƒ

https://segmentfault.com/a/1190000020255831



â–¼ç®€å•ç‰ˆæ·±æ‹·è´ï¼š**åªè€ƒè™‘æ™®é€šå¯¹è±¡å±æ€§**ï¼Œä¸è€ƒè™‘å†…ç½®å¯¹è±¡RegExpå’ŒDate, æ²¡æœ‰è§£å†³å¾ªç¯å¼•ç”¨!!!

```js
let deepClone=target=> {
    //éå¯¹è±¡ç±»å‹ç›´æ¥è¿”å›
    if (typeof target!=='object') return target;
    let cloneTarget=Array.isArray(target)? [] : {};
    //for in targetä¼šåŒ…æ‹¬åŸå‹é“¾ä¸Šç»§æ‰¿çš„å±æ€§,ä¸€èˆ¬ä¸è€ƒè™‘
    for (let key of Reflect.ownKeys(target)){
        //è¿™é‡Œæ¯æ¬¡é€šè¿‡é€’å½’å¾—åˆ°å±æ€§,çœå»åˆ¤æ–­æ˜¯å¦ä¸ºå¯¹è±¡çš„ä»£ç 
        cloneTarget[key]=deepClone(target[key]);
    }
    return cloneTarget;
}
```



ğŸŒŸä¹‹å‰åœ¨forå¾ªç¯ä¸­å†™çš„æ˜¯for(let key in obj) è¿™ç§ä¼šæ¼æ‰Symbolä½œä¸ºkeyçš„æƒ…å†µ!!!è€Œè¿™é‡Œé‡‡ç”¨çš„[`Reflect.ownKeys(target)`](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Reflect/ownKeys) :è¿”å›ä¸€ä¸ªåŒ…å«æ‰€æœ‰è‡ªèº«å±æ€§ï¼ˆä¸åŒ…å«ç»§æ‰¿å±æ€§ï¼‰çš„æ•°ç»„ã€‚(ç±»ä¼¼äº [`Object.keys()`](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/keys), ä½†ä¸ä¼šå—`enumerableå½±å“`).  å³ä½¿æ˜¯Symbolä¹Ÿä¼šæ·±æ‹·è´!!!

**Reflect.ownKeys` æ–¹æ³•è¿”å›ä¸€ä¸ªç”±ç›®æ ‡å¯¹è±¡è‡ªèº«çš„å±æ€§é”®ç»„æˆçš„æ•°ç»„ã€‚å®ƒçš„è¿”å›å€¼ç­‰åŒäº`Object.getOwnPropertyNames(target).concat(Object.getOwnPropertySymbols(target))ã€‚**



**Steps:**

1. åˆ¤æ–­æ˜¯å¦ä¸ºå¯¹è±¡, å¦‚æœä¸æ˜¯çš„è¯ç›´æ¥è¿”å› (å‡è®¾é™¤äº†å¯¹è±¡å¤–éƒ½æ˜¯åŸºæœ¬æ•°æ®ç±»å‹)
2. åˆ¤æ–­æ˜¯æ•°ç»„è¿˜æ˜¯å¯¹è±¡
3. éå†æ¯ä¸ªå±æ€§è¿›è¡Œé€’å½’æ·±æ‹·è´



â­•ç¼ºç‚¹: 1.æ— æ³•æ­£ç¡®è½¬æ¢RegExpå’ŒDate  2.å‡½æ•°æ²¡æœ‰æ‹·è´(ä½†ä¸€èˆ¬ä¸éœ€è¦å¯¹å‡½æ•°è¿›è¡Œæ‹·è´)  3.keyä¸ºSymbolçš„è¯ä¹Ÿæ˜¯åŸæ¥çš„Symbol  4.æ²¡æœ‰è§£å†³å¾ªç¯å¼•ç”¨çš„é—®é¢˜: target.target=target;  ä¼šæŠ¥é”™:Maximun call stack size exceeded



æµ‹è¯•:

```js
const target = {
    field1: new Date(),
    field2: function (n) {
        console.log(n);
    },
    field3: 'ConardLi',
    field4: {
        child: 'child',
        child2: {
            child2: [1,'child2']
        }
    },
    [s]:'symbol'
};
let copy=deepClone(target);
console.log(copy);
console.log(copy.field4.child2 === target.field4.child2);           //false
console.log(copy.field2 === target.field2);                         //true
console.log(Reflect.ownKeys(target)[4]===Reflect.ownKeys(copy)[4])  //true

```

âŒç”±äºæ²¡æœ‰è§£å†³å¾ªç¯å¼•ç”¨, å¦‚æœåœ¨è¿™é‡Œæ·»åŠ  target=target.target , åŸtargetæ˜¯ä¼šè‡ªåŠ¨æŒ‡å‘è‡ªå·±çš„ã€‚ä½†æ˜¯æˆ‘ä»¬æ‹·è´çš„å¯¹è±¡å°±ä¼šé™·å…¥æ— é™é€’å½’ï¼ï¼ï¼



**â–¼å¤æ‚ç‰ˆæ·±æ‹·è´**:åŸºäºç®€å•ç‰ˆçš„åŸºç¡€ä¸Šï¼Œè¿˜è€ƒè™‘äº†å†…ç½®å¯¹è±¡æ¯”å¦‚ Dateã€RegExp ç­‰å¯¹è±¡å’Œå‡½æ•°ä»¥åŠè§£å†³äº†å¾ªç¯å¼•ç”¨çš„é—®é¢˜ã€‚

```js
const isObject=target=>(typeof target==="object"||typeof target==="function")&&target!==null;

//mapæ˜¯ä¸ºäº†è§£å†³å¾ªç¯å¼•ç”¨!!!
function deepClone(target,map=new Map()) {
    //weakMapè®°å½•å°†å¯¹è±¡ä½œä¸ºkey,è®°å½•è¯¥å¯¹è±¡æ˜¯å¦åœ¨ä¹‹å‰å‡ºç°è¿‡
    if (map.get(target)){
        return target;
    }
    //å¯¹äºDate,RegExpçš„å¤„ç†å¾ˆæ£’!!!
    let constructor=target.constructor;
    if (/^(RegExp|Date)$/i.test(constructor.name)){
        return new constructor(target);
    }
    if (isObject(target)){
        map.set(target,true);
        const cloneTarget=Array.isArray(target)? []:{};
        for (let prop in target){
            if (target.hasOwnProperty(prop)){
                cloneTarget[prop]=deepClone(target[prop],map);
            }
        }
        return cloneTarget;
    }else {
        return target;
    }
}
```

â˜… å¦‚æœä½ åªè¦è€ƒè™‘å¯¹è±¡æœ¬èº«çš„å±æ€§ï¼Œè€Œä¸æ˜¯å®ƒçš„åŸå‹ï¼Œé‚£ä¹ˆä½¿ç”¨ [`getOwnPropertyNames()`](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/getOwnPropertyNames) æˆ–æ‰§è¡Œ [`hasOwnProperty()`](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/hasOwnProperty) æ¥ç¡®å®šæŸå±æ€§æ˜¯å¦æ˜¯å¯¹è±¡æœ¬èº«çš„å±æ€§

âŒè¿™ä¸€ç‰ˆå†™çš„ä¹Ÿä¸å¥½ï¼ï¼ï¼ å¹¶æ²¡æœ‰è€ƒè™‘å¯¹è±¡æ˜¯å‡½æ•°çš„é—®é¢˜ ï¼Œ è€Œä¸”æŠŠå‡½æ•°å½“targetæ‰§è¡Œæ‹·è´æ—¶è¿˜ä¼šæŠ¥é”™ï¼Œæ‹·è´å‡ºæ¥çš„å‡½æ•°åªæ˜¯ä¸ªå•çº¯å¸¦æœ‰nameï¼Œlengthå±æ€§çš„ä¸€ä¸ªobjectã€‚ å¹¶ä¸”è§£å†³å¾ªç¯å¼•ç”¨é‡‡ç”¨çš„æ˜¯mapï¼Œ æ˜æ˜¾é‡‡ç”¨weakmapæ›´å¥½ï¼Œå› ä¸ºè¿™é‡Œçš„keyæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå¾ˆå®¹æ˜“æƒ³åˆ°ä½¿ç”¨weakmap

â˜…å¦‚æœæˆ‘ä»¬è¦æ‹·è´çš„å¯¹è±¡éå¸¸åºå¤§æ—¶ï¼Œä½¿ç”¨`Map`ä¼šå¯¹å†…å­˜é€ æˆéå¸¸å¤§çš„é¢å¤–æ¶ˆè€—ï¼Œè€Œä¸”æˆ‘ä»¬éœ€è¦æ‰‹åŠ¨æ¸…é™¤`Map`çš„å±æ€§æ‰èƒ½é‡Šæ”¾è¿™å—å†…å­˜ï¼Œè€Œ`WeakMap`ä¼šå¸®æˆ‘ä»¬å·§å¦™åŒ–è§£è¿™ä¸ªé—®é¢˜ã€‚



ğŸš©**æœ€ç»ˆç‰ˆ**

```js
const isComplexDataType = obj => (typeof obj === 'object' || typeof obj === 'function') && (obj !== null)
const deepClone = function(obj, hash = new WeakMap()) {
    if(!obj) return null;
    let constructor=obj.constructor;
    if (/^(Date|RegExp)$/i.test(constructor.name)){
         return new constructor(obj)
    }

    if (hash.has(obj)) return hash.get(obj)
    //è¿™é‡Œæ˜¯ä¸ºäº†å¾—åˆ°æ‰€æœ‰çš„æ•°æ®æè¿°ç¬¦çš„å€¼,[Configurable],[Enumerable],[Writable],[Value]ç­‰
    let allDesc = Object.getOwnPropertyDescriptors(obj)
    //Object.createåŸæœ¬æ˜¯åˆ›å»ºä¸€ä¸ªæ–°å¯¹è±¡,å¹¶å°†ç¬¬ä¸€ä¸ªå‚æ•°ä½œä¸ºæ–°å¯¹è±¡çš„__proto__
    //å¹¶ä¸”ç»“åˆDescriptorsæ–¹æ³•åå¯ä»¥ç”¨ç¬¬äºŒä¸ªå‚æ•°æŒ‡å®šæ•°æ®æè¿°ç¬¦
    //è¿™æ ·ä¸€æ¥æ—¢è€ƒè™‘äº†æ•°ç»„
    let cloneObj = Object.create(Object.getPrototypeOf(obj), allDesc)
    hash.set(obj, cloneObj)
    //
    for (let key of Reflect.ownKeys(obj)) {
        cloneObj[key] = (isComplexDataType(obj[key]) && typeof obj[key] !== 'function') ?
            deepClone(obj[key], hash) : obj[key]
    }
    return cloneObj
}
```

**â˜…æ³¨è§£:**

1. é¦–å…ˆè€ƒè™‘äº†Dateå’ŒRegExpç‰¹æ®Šçš„å¼•ç”¨ç±»å‹, ç›´æ¥è°ƒç”¨å…¶æ„é€ å‡½æ•°å»ºç«‹æ–°å®ä¾‹
2. é‡‡ç”¨äº†WeakMapæ¥å­˜å‚¨å·²ç»éå†è¿‡çš„å¯¹è±¡, é˜²æ­¢å¾ªç¯å¼•ç”¨å’Œå†…å­˜æ³„æ¼
3. ä¸å¸¸èƒ½èƒ½æƒ³åˆ°çš„æ•°æ®æè¿°ç¬¦ä¹Ÿæƒ³åˆ°äº†, Object.getOwnPropertyDescriptors(obj)å¾—åˆ° objçš„[Configurable],[Enumerable],[Writable],[Value] ç­‰å±æ€§ã€‚ç„¶åç»“åˆObject.create()å°†è¿™äº›å±æ€§èµ‹å€¼ç»™cloneObj
4. ä¹‹å‰è¿˜éœ€è¦è¿›è¡Œæ•°ç»„å’Œå¯¹è±¡çš„åŒºåˆ†, è¿™é‡Œç›´æ¥é‡‡ç”¨ Object.getPrototypeOf(obj) å°±ä¸ç”¨åŒºåˆ†!!!  (è¿™ç§æ–¹å¼å»ºç«‹çš„æ•°ç»„åœ¨nodeæ˜¾ç¤ºä¸º Array{key:value} , ä½†å®é™…ä¸Šå°±æ˜¯æ•°ç»„, åœ¨v8ä¸­æ˜¾ç¤ºæ­£å¸¸!)
5. å±æ€§éå†é€’å½’èµ‹å€¼å°±å’Œå‰é¢çš„å·®ä¸å¤šäº†, ä¸è¿‡è¿™é‡Œå¹¶æ²¡æœ‰è€ƒè™‘å‡½æ•°çš„æ·±æ‹·è´, ä½†æ˜¯ä¸€èˆ¬ä¹Ÿä¸ä¼šå»è€ƒè™‘å‡½æ•°çš„æ·±æ‹·è´ (æˆ‘çŒœå¯ä»¥å°è¯•ç”¨bind...)  forå¾ªç¯è¿™é‡Œé‡‡ç”¨Reflect.ownKeysæœ‰ä¸€ä¸ªå¥½å¤„å°±æ˜¯ä¼šåŒ…æ‹¬Symbolé”®å€¼
6. æœ€åè¯´ä¸€ä¸‹forå¾ªç¯ä¸­çš„åˆ¤æ–­æ¡ä»¶, è¦è¿›è¡Œé€’å½’

â—ç¼ºç‚¹: è¿˜æœ‰ä¸€äº›Map, Setå¯¹è±¡å¯èƒ½æ²¡æœ‰è€ƒè™‘, ä½†å·²ç»å¾ˆå®Œç¾äº†!!!

[Object.create](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/create)   [Object.defineProperties()](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/defineProperties)   [Object.getOwnPropertyDescriptors()](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/getOwnPropertyDescriptors)



æµ‹è¯•ä»£ç ï¼š

```js
let s=Symbol(123);
const target = {
    field1: new Date(),
    field2: function (n) {
        console.log(n);
    },
    field3: 'ConardLi',
    field4: {
        child: 'child',
        child2: {
            child2: [1,'child2']
        }
    },
    [s]:'symbol'
};
target.target=target;
let copy=deepClone(target);
console.log(copy);
console.log(copy.field4.child2 === target.field4.child2);           //false
console.log(copy.field2 === target.field2);                         //true
console.log(Reflect.ownKeys(target)[4]===Reflect.ownKeys(copy)[4])  //true
console.log(copy.target===copy);      //true
```



### å¯„ç”Ÿç»„åˆå¼ç»§æ‰¿

```js
function SuperType(name){
    this.name = name;
    this.colors = ["red", "blue", "green"];
}
SuperType.prototype.sayName = function() {
    console.log(this.name);
};
function SubType(name, age){
    // ç›—ç”¨æ„é€ å‡½æ•°ç»§æ‰¿å±æ€§
    SuperType.call(this, name);
    this.age = age;
}
// ç»§æ‰¿æ–¹æ³• (ä¸ç»„åˆç»§æ‰¿ä¸åŒçš„åœ°æ–¹)
SubType.prototype = Object.create(SuperType.prototype);
SubType.prototype.constructor=SubType;
SubType.prototype.sayAge = function() {
    console.log(this.age);
};
```



### å‘å¸ƒè®¢é˜…æ¨¡å¼

```js
/*å‘å¸ƒè®¢é˜…è€…æ¨¡å¼*/

class EventEmitter {
    constructor() {
        //å­˜æ”¾å¯¹åº”äº‹ä»¶
        this.event={}
    }

    //è®¢é˜…äº‹ä»¶, ä¸€ä¸ªäº‹ä»¶å¯èƒ½ä¸æ­¢ä¸€ä¸ªcallback
    on(eventName,callback){
        if (this.event[eventName]){
            this.event[eventName].push(callback);
        }else {
            this.event[eventName]=[callback];
        }
    }

    //è§¦å‘äº‹ä»¶
    emit(eventName,once=false, ...args){
        if (this.event[eventName]){
            let tasks=this.event[eventName].concat();
            tasks.forEach(callback=>callback(...args));
        }
        if (once){
            delete this.event[eventName];
        }
    }

    //ç§»é™¤æŸä¸ªäº‹ä»¶ä¸­çš„å›è°ƒå‡½æ•°
    off(eventName,callback){
        if (this.event[eventName]){
            this.event[eventName]=this.event[eventName].filter(
                func=>func!==callback
            )
        }
    }
}

let eventBus = new EventEmitter()
let fn1 = function(name, age) {
    console.log(`${name} ${age}`)
}
let fn2 = function(name, age) {
    console.log(`hello, ${name} ${age}`)
}
eventBus.on('aaa', fn1)
eventBus.on('aaa', fn2)
eventBus.emit('aaa', false, 'å¸ƒå…°', 12)
eventBus.off('aaa',fn1);
eventBus.emit('aaa', false, 'å¸ƒå…°', 12)
```



### é˜²æŠ–èŠ‚æµ

https://www.jianshu.com/p/c8b86b09daf0

 

HTMLï¼š

```html
<div id="content" style="height:150px;line-height:150px;text-align:center; color: #fff;background-color:#ccc;font-size:80px;"></div>
<script>
    let num = 1;
    let content = document.getElementById('content');
	  function count() {
        content.innerHTML = num++;
    };
    content.onmousemove = count;
</script>
```



#### é˜²æŠ–debounce

éç«‹å³æ‰§è¡Œ:

```js
const debounce = function (func, wait,...rest) {
 let timeout;
 return function () {
  let context = this;
  let args = rest.concat([...arguments]);
  if (timeout) clearTimeout(timeout);
  timeout = setTimeout(() => {
   func.apply(context, args);
  }, wait)
 }
}
```

ç«‹å³æ‰§è¡Œ:

```js
const debounce = function (func, wait, ...rest) {
 let timeout;
 return function () {
  let context = this;
  let args = rest.concat([...arguments]);
  if (timeout) clearTimeout(timeout);
  let callNow = !timeout;
  timeout = setTimeout(() => {
   timeout = null;
  }, wait)
  if (callNow) {
   func.apply(context, args);
  }
 }
}
```



#### èŠ‚æµthrottle

æ—¶é—´æˆ³ç‰ˆï¼š

```js
const throttle = function (func, wait, ...rest) {
 let previous = 0;
 return function () {
  let now = Date.now(),
   context = this,
   args = rest.concat([...arguments]);
  if (now - previous > wait) {
   func.apply(context, args);
   previous = now;
  }
 }
}
```



å®šæ—¶å™¨ç‰ˆ:

```js
const throttle = function (func, wait, ...rest) {
 let timeout;
 return function () {
  let context = this,
   args = rest.concat([...arguments]);
     if (!timeout){
       timeout=setTimeout(()=>{
        timeout=null;
       },wait);
       func.apply(context,args);
     }
 }
}
```



### æ‡’åŠ è½½

https://zhuanlan.zhihu.com/p/25455672



å›¾ç‰‡çš„æ‡’åŠ è½½åŸç†å¯ä»¥åˆ†ä¸ºä¸‰æ­¥ ï¼š

1. æˆ‘ä»¬å…ˆå®šä¹‰å¥½imgå…ƒç´ ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡DOMåŠ¨æ€æ·»åŠ ï¼Œå¯ä»¥é¢„å…ˆå®šä¹‰å¥½imgå…ƒç´ ï¼Œå¹¶ç»™ä»–ä»¬ä¸€ä¸ªåŸºç¡€çš„åŠ è½½çš„å›¾ç‰‡ä½œä¸ºå…¬å…±å›¾ç‰‡ã€‚
2. ç»™æ¯ä¸ªimgå…ƒç´ åŠ ä¸Šdata-srcæ¥å­˜æ”¾çœŸæ­£å›¾ç‰‡çš„èµ„æºã€‚
3. æˆ‘ä»¬é€šè¿‡å›¾ç‰‡åœ¨æ•´ä¸ªç•Œé¢çš„é«˜åº¦ä½ç½®æ¥å’Œç›®å‰å¯è§†åŒºåŸŸçš„é«˜åº¦è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœåœ¨å¯æ˜¯åŒºåŸŸå†…å°±è¿›è¡Œå›¾ç‰‡èµ„æºçš„åŠ è½½ï¼Œä¸ç„¶å°±å…ˆä¸åŠ è½½ï¼Œä»è€Œæé«˜æ€§èƒ½ã€‚



way1:

ä¼ ç»Ÿçš„å®ç°æ–¹æ³•æ˜¯ï¼Œç›‘å¬åˆ°`scroll`äº‹ä»¶åï¼Œè°ƒç”¨ç›®æ ‡å…ƒç´ ï¼ˆç»¿è‰²æ–¹å—ï¼‰çš„[`getBoundingClientRect()`](https://developer.mozilla.org/en/docs/Web/API/Element/getBoundingClientRect)æ–¹æ³•ï¼Œå¾—åˆ°å®ƒå¯¹åº”äºè§†å£å·¦ä¸Šè§’çš„åæ ‡ï¼Œå†åˆ¤æ–­æ˜¯å¦åœ¨è§†å£ä¹‹å†…ã€‚

ç¼ºç‚¹:  `scroll`äº‹ä»¶å¯†é›†å‘ç”Ÿï¼Œè®¡ç®—é‡å¾ˆå¤§ï¼Œå®¹æ˜“é€ æˆ[æ€§èƒ½é—®é¢˜](http://www.ruanyifeng.com/blog/2015/09/web-page-performance-in-depth.html)ã€‚(ä¸è¿‡å¯ä»¥é€šè¿‡èŠ‚æµæ¥è§£å†³)

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Lazyload 2</title>
    <style>
        img {
            display: block;
            margin-bottom: 50px;
            height: 200px;
        }
    </style>
</head>
<body>
<img src="m5.jpgloading.gif" data-src="m5.jpg">
<img src="m5.jpgloading.gif" data-src="m5.jpg">
<img src="m5.jpgloading.gif" data-src="m5.jpg">
<img src="m5.jpgloading.gif" data-src="m5.jpg">
<img src="m5.jpgloading.gif" data-src="m5.jpg">
<img src="m5.jpgloading.gif" data-src="m5.jpg">
<img src="m5.jpgloading.gif" data-src="m5.jpg">
<img src="m5.jpgloading.gif" data-src="m5.jpg">
<img src="m5.jpgloading.gif" data-src="m5.jpg">
<img src="m5.jpgloading.gif" data-src="m5.jpg">
<img src="m5.jpgloading.gif" data-src="m5.jpg">
<img src="m5.jpgloading.gif" data-src="m5.jpg">
<script>

    function throttle(func, wait) {
        let timeout;
        return function () {
            let context = this;
            let args = arguments;
            if (!timeout) {
                timeout = setTimeout(() => {
                    func.apply(context, args);
                    timeout = null;
                }, wait)
            }
        }
    }

    function lazyLoad() {
        let images = document.getElementsByTagName('img');
        let len = images.length;
        let n = 0;      //å­˜å‚¨å›¾ç‰‡åŠ è½½åˆ°çš„ä½ç½®ï¼Œé¿å…æ¯æ¬¡éƒ½ä»ç¬¬ä¸€å¼ å›¾ç‰‡å¼€å§‹éå†
        return function () {
            for (let i = n; i < len; i++) {
                let rect = images[i].getBoundingClientRect();
                //rect.topæ˜¯ç›¸å¯¹äºviewportçš„æœ€é«˜ç‚¹,åœ¨å½“å‰è§†å£çš„æœ€é«˜ç‚¹å‘ä¸Štopä¸ºè´Ÿ, å‘ä¸‹topä¸ºæ­£
                //window.innerHeightå°±æ˜¯å½“å‰çª—å£çš„é«˜åº¦, å½“å›¾ç‰‡åˆšå¥½ä»ä¸‹é¢è¿›å…¥åˆ°è§†å£ä¾¿å¼€å§‹åŠ è½½
                if (rect.top < window.innerHeight&&rect.bottom>0) {
                    if (images[i].getAttribute('src') === 'm5.jpgloading.gif') {
                        images[i].src = images[i].getAttribute('data-src');
                    }
                    n++;
                }
            }
        }
    }
    let loadImages = lazyLoad();
    loadImages();          //åˆå§‹åŒ–é¦–é¡µçš„é¡µé¢å›¾ç‰‡
    window.addEventListener('scroll', throttle(loadImages, 500), false);
</script>
</body>
</html>
```

ğŸŒŸæˆ‘è¿™é‡Œæ˜¯å¼ºè¡ŒæŒ‰ç…§è§†å£æ¥è®¡ç®—çš„ rect.top < window.innerHeight&&rect.bottom>0  ç½‘ä¸Šç»™å‡ºçš„æ˜¯åªè¦åœ¨è§†å£ä¸Šé¢å°±è¿›è¡ŒåŠ è½½

ğŸŒŸè¿™é‡Œnæ˜¯ä¸ºäº†é˜²æ­¢é‡å¤è®¡ç®—, å·²ç»åŠ è½½è¿‡çš„å°±ä¸ç”¨å†å¾ªç¯ã€‚ä½†æ˜¯è¿™æ ·ä¼šå¸¦æ¥ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœå½“å‰é¡µé¢åœ¨ä¸åœ¨é¡¶éƒ¨è¿›è¡Œåˆ·æ–°çš„è¯ï¼Œé‚£ä¹ˆé¡¶éƒ¨çš„å›¾ç‰‡åœ¨ä¹‹åæ— æ³•çœ‹è§ã€‚ï¼ˆä¸è¿‡æƒ…å†µå¾ˆå°‘è§...ï¼‰



way2: IntersectionObserver

æ–°çš„api

```js
function lazyLoad() {
    let imgList=[...document.querySelectorAll('img')];

    return function () {
        let observer=new IntersectionObserver(entries => {
            entries.forEach(function (entry){
                if (entry.isIntersecting){
                    //setTimeoutæ˜¯åœ¨æ¨¡æ‹Ÿç½‘é€Ÿå»¶è¿Ÿ, å®é™…ä½¿ç”¨å¯ä»¥çœç•¥
                    setTimeout(()=>{
                        entry.target.src=entry.target.dataset.src;
                        observer.unobserve(entry.target);
                    },500);

                }
            })
        })
        imgList.forEach(function (img){
            observer.observe(img);
        })
    }
}

let loadImages = lazyLoad();
loadImages();          //åˆå§‹åŒ–é¦–é¡µçš„é¡µé¢å›¾ç‰‡
```

â—æ³¨æ„, è¿™ä¸ªå‡½æ•°ä¼šè‡ªåŠ¨ç›‘å¬å¹¶è°ƒç”¨ ç›¸åº”çš„å›è°ƒå‡½æ•° let io = new IntersectionObserver(callback, option); æ‰€ä»¥ä¸ç”¨å†addEventListeneräº†!  ä¹Ÿä¸éœ€è¦èŠ‚æµ, å› ä¸ºä¸ä¼šè¿ç»­è§¦å‘!

callbackä¸€èˆ¬ä¼šè§¦å‘ä¸¤æ¬¡ã€‚ä¸€æ¬¡æ˜¯ç›®æ ‡å…ƒç´ åˆšåˆšè¿›å…¥è§†å£ï¼ˆå¼€å§‹å¯è§ï¼‰ï¼Œå¦ä¸€æ¬¡æ˜¯å®Œå…¨ç¦»å¼€è§†å£ï¼ˆå¼€å§‹ä¸å¯è§ï¼‰









### å‡½æ•°curryingåŒ–

å‚è€ƒ:

https://juejin.cn/post/6844903882208837645

[curringå’Œbind](https://blog.csdn.net/u010552788/article/details/50850453)

```js
function currying(fn) {
    //è¿™é‡Œåˆ©ç”¨äº†é—­åŒ…æ¥ä¿ç•™æ¯ä¸ªfnä»¥ä¾¿åç»­è¿›è¡Œæ¯”è¾ƒlength
    let judge=(...args)=>{
        // console.log(args);
        //å¦‚æœç»™å‡ºçš„å‚æ•°æ•°ç›®ç­‰äºäº†æˆ‘ä»¬éœ€è¦çš„å‚æ•°æ•°ç›®,å°±æ‰§è¡Œå‡½æ•°
        if (args.length===fn.length) return fn(...args);
        //å¦åˆ™çš„è¯å°†è¿™äº›å‚æ•°ä¼ é€’ä¸‹å»,è®©ä¸‹ä¸€ä¸ªå‡½æ•°ç»§ç»­åˆ¤æ–­ç›´åˆ°å‚æ•°æ•°ç›®æ»¡è¶³è¦æ±‚
        return (...arg)=>judge(...args,...arg);
    }
    return judge;
}

let _fn = currying(function(a,b,c,d,e){
    console.log(a,b,c,d,e)
});

//è¿›è¡Œcurryä¹‹å‰çš„å‡½æ•°lengthç­‰äºç°åœ¨curryä¹‹åçš„length,åˆ™ç›´æ¥è°ƒç”¨
//judge(1,2,3,4,5)==> fn(1,2,3,4,5)
_fn(1,2,3,4);     // print: 1,2,3,4,5
_fn(1)(2)(3,4,5);   // print: 1,2,3,4,5
// _fn(1,2)(3,4)(5);   // print: 1,2,3,4,5
// _fn(1)(2)(3)(4)(5); // print: 1,2,3,4,5
```



ğŸŒŸå®é™…ä¸Šå°±æ˜¯æŠŠå‚æ•°ä¼ é€’ä¸‹å», ç›´åˆ°å‚æ•°æ•°ç›®æ»¡è¶³è¦æ±‚



### Ajax

```js
const getJSON = function(url) {
    return new Promise((resolve, reject) => {
        const xhr = XMLHttpRequest ? new XMLHttpRequest() : new ActiveXObject('Mscrosoft.XMLHttp');
        xhr.open('GET', url, false);
        xhr.setRequestHeader('Accept', 'application/json');
        xhr.onreadystatechange = function() {
            if (xhr.readyState !== 4) return;
            if (xhr.status === 200 || xhr.status === 304) {
                resolve(xhr.responseText);
            } else {
                reject(new Error(xhr.responseText));
            }
        }
        xhr.send();
    })
}
```





### Promiseç³»åˆ—



#### Promise.prototype.catch()

> `catch()æ–¹æ³•`è¿”å›ä¸€ä¸ªPromiseï¼Œå¹¶ä¸”å¤„ç†æ‹’ç»çš„æƒ…å†µã€‚å®ƒçš„è¡Œä¸ºä¸è°ƒç”¨Promise.prototype.then(undefined, onRejected) ç›¸åŒã€‚



```js
Promise.prototype.myCatch=function (rejectFn) {
    return this.then(null,rejectFn);
}
```

ğŸŒŸæœ¬è´¨ä¸Šæ˜¯åœ¨è°ƒç”¨thenæ–¹æ³•ä¸­çš„onRejectedå‡½æ•°





#### Promise.prototype.finally()

> `finally()æ–¹æ³•`è¿”å›ä¸€ä¸ªPromiseã€‚åœ¨promiseç»“æŸæ—¶ï¼Œæ— è®ºç»“æœæ˜¯fulfilledæˆ–è€…æ˜¯rejectedï¼Œéƒ½ä¼šæ‰§è¡ŒæŒ‡å®šçš„å›è°ƒå‡½æ•°ã€‚åœ¨finallyä¹‹åï¼Œè¿˜å¯ä»¥ç»§ç»­thenã€‚å¹¶ä¸”ä¼šå°†å€¼åŸå°ä¸åŠ¨çš„ä¼ é€’ç»™åé¢çš„then




```js
Promise.prototype.myFinally=function (onFinally) {
    const callback=()=>typeof onFinally==="function"? onFinally():null;
    return this.then(
        value => Promise.resolve(callback()).then(()=>value),
        reason => Promise.resolve(callback()).then(()=>{throw reason})
    )
}
```

â–¼finallyå®é™…ä¸Šå°±æ˜¯æŠŠçˆ¶promiseåŸæ ·ä¼ é€’ä¸‹å»ï¼Œ æ‰€ä»¥è¿™é‡Œè¦**å…ˆåˆ¤æ–­onFinallyæ˜¯å¦æ˜¯ä¸€ä¸ªå‡½æ•°**ï¼Œå¦‚æœæ˜¯å‡½æ•°çš„è¯æ‰æ‰§è¡Œï¼é‚£ä¹ˆè¿™é‡Œä¸ºä»€ä¹ˆè¦æŠŠcallbackçš„æ‰§è¡Œæ”¾åœ¨Promise.resolveä¸­è¿›è¡Œå¤„ç†å‘¢ï¼Ÿ

ğŸŒŸå› ä¸º**finally()å¦‚æœreturnäº†ä¸€ä¸ªrejectçŠ¶æ€çš„Promiseï¼Œå°†ä¼šæ”¹å˜å½“å‰Promiseçš„çŠ¶æ€**ï¼Œ æ‰€ä»¥è¿™é‡Œæ˜¯ä¸ºäº†é˜²æ­¢è¿™ç§æƒ…å†µï¼Œåœ¨finally()æ²¡æœ‰è¿”å›rejectæ€Promiseæˆ–throwé”™è¯¯çš„æƒ…å†µä¸‹ï¼Œå»æ‰`Promise.resolve`ä¹Ÿæ˜¯ä¸€æ ·çš„



**ğŸš©thenæ–¹æ³•æ˜¯å®šä¹‰åœ¨Promiseçš„prototypeä¸Šçš„!**



#### Promise.resolve()

> `Promise.resolve(value)`æ–¹æ³•è¿”å›ä¸€ä¸ªä»¥ç»™å®šå€¼è§£æåçš„Promise å¯¹è±¡ã€‚å¦‚æœè¯¥å€¼ä¸ºpromiseï¼Œè¿”å›è¿™ä¸ªpromiseï¼›å¦‚æœè¿™ä¸ªå€¼æ˜¯thenableï¼ˆå³å¸¦æœ‰"then" æ–¹æ³•)ï¼‰ï¼Œè¿”å›çš„promiseä¼šâ€œè·Ÿéšâ€è¿™ä¸ªthenableçš„å¯¹è±¡ï¼Œé‡‡ç”¨å®ƒçš„æœ€ç»ˆçŠ¶æ€ï¼›å¦åˆ™è¿”å›çš„promiseå°†ä»¥æ­¤å€¼å®Œæˆã€‚æ­¤å‡½æ•°å°†ç±»promiseå¯¹è±¡çš„å¤šå±‚åµŒå¥—å±•å¹³ã€‚



```js
Promise.myResolve=function (value) {
    if (Promise.prototype.isPrototypeOf(value)) return value;
    return new Promise(resolve => resolve(value));
}
```



#### Promise.reject()

> `Promise.reject()`æ–¹æ³•è¿”å›ä¸€ä¸ªå¸¦æœ‰æ‹’ç»åŸå› çš„Promiseå¯¹è±¡ã€‚



```js
Promise.myReject=function (reason) {
    return new Promise((resolve, reject) => reject(reason))
}
```





#### Promise.all()

> `Promise.all(iterable)`æ–¹æ³•è¿”å›ä¸€ä¸ª Promise å®ä¾‹ï¼Œæ­¤å®ä¾‹åœ¨ iterable å‚æ•°å†…æ‰€æœ‰çš„ promise éƒ½â€œå®Œæˆï¼ˆresolvedï¼‰â€æˆ–å‚æ•°ä¸­ä¸åŒ…å« promise æ—¶å›è°ƒå®Œæˆï¼ˆresolveï¼‰ï¼›å¦‚æœå‚æ•°ä¸­  promise æœ‰ä¸€ä¸ªå¤±è´¥ï¼ˆrejectedï¼‰ï¼Œæ­¤å®ä¾‹å›è°ƒå¤±è´¥ï¼ˆrejectï¼‰ï¼Œå¤±è´¥åŸå› çš„æ˜¯ç¬¬ä¸€ä¸ªå¤±è´¥ promise çš„ç»“æœã€‚



â—è¿™é‡Œé¦–å…ˆè¦ä¿è¯ä¼ å…¥çš„valuesæ˜¯ä¸€ä¸ªæ•°ç»„!!

```js
Promise.myAll = function (values) {
    let count = 0;
    let result = [];
    
    return new Promise((resolve, reject) => {
        values.forEach((v,i) => {
            Promise.resolve(v).then(
                value => {
                    count++;
                    result[i]=value;
                    if (count === values.length) {
                        resolve(result);
                    }
                },
                reason => {
                    reject(reason);
                }
            )
        })
    })
}
```

å…¶å®è¿™é‡Œæœ‰å¾ˆå¤šå‘çš„ï¼ï¼ï¼

1. ä¸€å¼€å§‹æˆ‘æ²¡æœ‰ä½¿ç”¨forEachä¸­çš„indexå‚æ•°ï¼Œ çº¯ç²¹æ˜¯result.pushï¼Œè¿™æ ·ä¼šå¯¼è‡´æœ€åè¿”å›çš„resultæ•°ç»„ä¸­valueçš„é¡ºåºå˜æˆäº†æŒ‰æ‰§è¡Œé¡ºåºæ¥æ’åˆ—ï¼Œ ä½†æ˜¯ <span style="font-weight:bold; color:red;">è¿”å›å€¼åº”è¯¥æŒ‰ç…§å‚æ•°å†…çš„ `promise` é¡ºåºæ’åˆ—ï¼Œè€Œä¸æ˜¯ç”±è°ƒç”¨ `promise` çš„å®Œæˆé¡ºåºå†³å®šã€‚</span>æ‰€ä»¥è¿™é‡Œå¿…é¡»è¦ç”¨indexæ¥æŒ‡å®šï¼ï¼ï¼
2. åˆ¤æ–­æ˜¯å¦è®©å¤§çš„promise resolveçš„æ¡ä»¶ï¼Œ æˆ‘ä¸€å¼€å§‹æƒ³çš„æ˜¯result.length===values.length, ä½†æ˜¯ç”±ä¸Šé¢ä¸€ä¸ªå‘å¯ä»¥çŸ¥é“, å¦‚æœé¡ºåºæœ€åçš„é‚£ä¸ªpromiseæå‰å®Œæˆæ˜¯å¯ä»¥ç›´æ¥è®©resultçš„lengthç­‰äºvalues.lengthçš„ï¼æ‰€ä»¥è¦ç”¨countè¿›è¡Œåˆ¤æ–­
3. Promise.resolve(v)è¿˜æ˜¯å’Œä»¥å‰ä¸€æ ·, æ–¹ä¾¿å°†ä¸æ˜¯promiseçš„å‚æ•°è½¬æ¢ä¸ºpromise
4. Promise.allå¯¹æ•°ç»„ä¸­çš„promiseä¾æ¬¡è¿›è¡Œ"æ¶ˆè´¹"(then), ç„¶åå¾—åˆ°"ç”Ÿäº§è€…"ç”Ÿäº§çš„value,æœ€åä¸€èµ·è¿”å›
5. æˆ‘æš‚æ—¶ä¸çŸ¥é“countå’Œresultåœ¨å¤–é¢å®šä¹‰çš„å¥½å¤„, ...



æµ‹è¯•ä»£ç 

```js
let p1 = new Promise(resolve => {
    console.time('p1')
    setTimeout(function () {
        resolve('fast');
        console.log("fast promise");
    }, 1000);
    console.timeEnd('p1')
})

let p2 = new Promise(resolve => {
    console.time('p2')
    setTimeout(function () {
        resolve('medium');
        console.log("medium promise");
    }, 2000);
    console.timeEnd('p2')
})
let p3 = new Promise(resolve => {
    console.time('p3')
    setTimeout(function () {
        resolve('slow');
        console.log("slow promise");
    }, 1000);
    console.timeEnd('p3')
})

Promise.myAll([p1, p2, p3]).then(values => {
    console.log(values);
})
```



#### Promise.allSettled()



è¯¥`Promise.allSettled()`æ–¹æ³•è¿”å›ä¸€ä¸ªåœ¨<span style="font-weight:bold; color:red;">æ‰€æœ‰</span>ç»™å®šçš„promiseéƒ½å·²ç»`fulfilled`æˆ–`rejected`åçš„promiseï¼Œå¹¶å¸¦æœ‰ä¸€ä¸ªå¯¹è±¡æ•°ç»„ï¼Œæ¯ä¸ªå¯¹è±¡è¡¨ç¤ºå¯¹åº”çš„promiseç»“æœã€‚

å½“æ‚¨æœ‰å¤šä¸ªå½¼æ­¤ä¸ä¾èµ–çš„å¼‚æ­¥ä»»åŠ¡æˆåŠŸå®Œæˆæ—¶ï¼Œæˆ–è€…æ‚¨æ€»æ˜¯æƒ³çŸ¥é“æ¯ä¸ª`promise`çš„ç»“æœæ—¶ï¼Œé€šå¸¸ä½¿ç”¨å®ƒã€‚

â—å¯¹æ¯”Promise.allæœ‰ä¸¤ä¸ªåŒºåˆ«:

1. Promise.allåªè¦æœ‰ä¸€ä¸ªrejectedçŠ¶æ€ç›´æ¥è¿”å›,è€Œè¿™é‡Œå³ä½¿æ˜¯rejectedä¹Ÿä¼šå…¨éƒ¨æ‰§è¡Œå®Œ
2. è¿”å›çš„æ•°æ®ä¸åŒpromiseå°±æ˜¯å•çº¯çš„resultæˆ–reason, 

â–¼Promise.allSettled çš„ç»“æœæ•°ç»„ä¸­å¯èƒ½åŒ…å«ä»¥ä¸‹ä¸¤ç§æ ¼å¼çš„æ•°æ®

- {status:"fulfilled", value:result} å¯¹äºæˆåŠŸçš„å“åº”
- {status:"rejected", reason:error} å¯¹äº error



```js
Promise.myAllSettled = function (values) {
    let count = 0;
    let res = [];
    return new Promise((resolve, reject) => {
        if (!Array.isArray(values)) {
            reject(new TypeError("not iterable!"))
        }
        values.forEach((v, i) => {
            Promise.resolve(v).then(
                value => {
                    res[i] = {status:'fulfilled',value}
                },
                reason => {
                    res[i] = {status:'rejected',reason};
                }
            ).finally(()=>{
                if (++count===values.length) resolve(res);
            })
        })
    })
}
```

ğŸ’£å¼€å¤´æ–°å¢äº†å¯¹valuesçš„åˆ¤æ–­, å› ä¸ºå®é™…ä¸Šè°ƒç”¨æ—¶å¦‚æœvaluesä¸æ˜¯ä¸€ä¸ªæ•°ç»„ä¼šæŠ¥é”™TypeError

ğŸŒŸè¿™é‡Œä¸»è¦æ˜¯å‚è€ƒäº†Promise.allç„¶ååšå‡ºäº†ä¸€äº›æ”¹åŠ¨

ğŸŒŸä¸€å¼€å§‹æˆ‘æ˜¯resolveå’Œrejectä¸¤ç§æ–¹æ³•éƒ½å†™count++å’Œåˆ¤æ–­, é‡‡ç”¨finallyå¯ä»¥å¾ˆå¥½çš„å‡å°‘å†—ä½™ä»£ç !





â–¼é‡‡ç”¨Promise.allæ¥å®ç°Promise.allSettled:

```js
Promise.myAllSettledPlus=function (values) {
    if (!Array.isArray(values)) {
        return  Promise.reject(new TypeError("not iterable!"))
    }
    return Promise.myAll(values.map(v=>Promise.resolve(v).then(
        value =>{return  { status: 'fulfilled', value }},
        reason => {return  { status: 'rejected', reason }}
    )))
}
```



ğŸŒŸå…¶å®ç›¸å½“äºæ˜¯å…ˆé€šè¿‡mapå¾—åˆ°æ‰§è¡Œåçš„ç»“æœ, thenæ–¹æ³•ä¸­returnäº†ä¸€ä¸ªå€¼çš„è¯ï¼Œé‚£ä¹ˆ then è¿”å›çš„ Promise å°†ä¼šæˆä¸ºæ¥å—çŠ¶æ€ï¼Œå¹¶ä¸”å°†è¿”å›çš„å€¼ä½œä¸ºæ¥å—çŠ¶æ€çš„å›è°ƒå‡½æ•°çš„å‚æ•°å€¼ã€‚ è¿™æ ·çš„è¯ä¼ é€’ç»™Promise.allçš„å‚æ•°å°±å…¨æ˜¯æ¥æ”¶çŠ¶æ€ä¸”å¸¦æœ‰resultçš„Promiseäº†

















